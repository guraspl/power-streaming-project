<html>

<head>
    <title>Sender Streaming Video</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
    <video id="player" controls></video>
    <device type="media" onchange="update(this.data)"></device>

    <script>
        function update(stream) {
            document.querySelector('video').src = stream.url;
        }
    </script>
    <p id="printData"></p>
    <script>
        var player = document.getElementById('player');
        var printData = document.getElementById('printData');
        var count = 0;
        var streamRecorder;
        var webcamstream;
        var connection = new WebSocket('ws://localhost:8765/');
        function isOpen(ws) { return ws.readyState === ws.OPEN }
        connection.onmessage = function (evt) {
            console.log(evt);
        };
        function startRecording() {
            streamRecorder = webcamstream.record();
            setTimeout(stopRecording, 10000);
        }
        function stopRecording() {
            streamRecorder.getRecordedData(postVideoToServer);
        }
        function postVideoToServer(videoblob) {

            var data = {};
            data.video = videoblob;
            data.metadata = 'test metadata';
            data.action = "upload_video";
            jQuery.post("http://www.kongraju.in/uploadvideo.php", data, onUploadSuccess);
        }
        var handleSuccess = function (stream) {
            var context = new AudioContext();
            // var source = context.createMediaStreamSource(stream);
            // var processor = context.createScriptProcessor(1024, 1, 1);


            // source.connect(processor);
            // processor.connect(context.destination);

            // processor.onaudioprocess = function (e) {
            //     // Do something with the data, i.e Convert this to WAV
            //   //  if (!isOpen(connection)) return;
            //     var inputData = [];
            //     for (var channel = 0; channel < e.outputBuffer.numberOfChannels; channel++) {
            //         inputData.push(e.inputBuffer.getChannelData(channel));
            //     }
            //     printData.innerHTML=JSON.stringify(inputData);
            //     connection.send(JSON.stringify({ itration: ++count, data: inputData.join(","), userId: "123456" }));
            // };
            if (window.URL) {
                console.log("~~~" + Math.random());//000000000000000000000000000000000000000000000

                //connection.send(stream);
                player.srcObject = stream;
                webcamstream = stream;
            } else {
                console.log("---" + Math.random());
                player.src = stream;
            }
        };


        alert("ss");
        if (true)
            navigator.mediaDevices.getUserMedia({
                video: {
                    frameRate: 15
                }
            })
                .then(handleSuccess);
    </script>
</body>

</html>