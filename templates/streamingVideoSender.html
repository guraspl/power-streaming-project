<html>

<head>
    <title>Sender Streaming Video</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
    <video id="player" controls></video>
    <device type="media" onchange="update(this.data)"></device>
    <button onclick="connection.close()">Close Socket</button>
    <script>
        function update(stream) {
            document.querySelector('video').src = stream.url;
        }
    </script>
    <p id="printData"></p>
    <script src="{{ url_for('static', filename='MediaStreamRecorder.js') }}"> </script>
    <script src="{{ url_for('static', filename='mediaDevices-getUserMedia-polyfill.js') }}"> </script>
    <!-- <script src="https://cdn.webrtc-experiment.com/MediaStreamRecorder.js"> </script> -->
    <script>
        // set up basic variables for app

        var record = document.querySelector('.record');
        var stop = document.querySelector('.stop');
        var soundClips = document.querySelector('.sound-clips');
        var canvas = document.querySelector('.visualizer');
        var mainSection = document.querySelector('.main-controls');

        // disable stop button while not recording

        stop.disabled = true;

        // visualiser setup - create web audio api context and canvas

        var audioCtx = new (window.AudioContext || webkitAudioContext)();
        var canvasCtx = canvas.getContext("2d");

        //main block for doing the audio recording

        if (navigator.mediaDevices.getUserMedia) {
            console.log('getUserMedia supported.');

            var constraints = { audio: true, video: true };
            var chunks = [];

            var onSuccess = function (stream) {
                var mediaRecorder = new MediaRecorder(stream);


                function doRecordData() {
                    mediaRecorder.start();
                }

                function doStopAndPost() {
                    mediaRecorder.stop();
                }

                mediaRecorder.onstop = function (e) {
                    audio.controls = true;
                    var blob = new Blob(chunks, { 'type': 'audio/ogg; codecs=opus' });
                    chunks = [];
                    var audioURL = window.URL.createObjectURL(blob);
                    audio.src = audioURL;
                    console.log("recorder stopped");
                }

                mediaRecorder.ondataavailable = function (e) {
                    chunks.push(e.data);
                }
            }

            var onError = function (err) {
                console.log('The following error occured: ' + err);
            }

            navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);

        } else {
            console.log('getUserMedia not supported on your browser!');
        }
    </script>
    <script>
        /*
        var player = document.getElementById('player');
        var mediaRecorder = null;
        var count = 0;
        var mediaConstraints = {
            audio: true,
            video: true
        };


        var connection = new WebSocket('ws://localhost:8765/');
        function isOpen(ws) { return ws.readyState === ws.OPEN }
        connection.onmessage = function (evt) {
            console.log(evt);
            // mediaRecorder.clearOldRecordedFrames();
            mediaRecorder.start(3000);
        };

        navigator.getUserMedia(mediaConstraints, onMediaSuccess, onMediaError);

        function onMediaSuccess(stream) {

            mediaRecorder = new MediaStreamRecorder(stream);
            mediaRecorder.mimeType = 'video/mp4';
            mediaRecorder.ondataavailable = function (blob) {
                // POST/PUT "Blob" using FormData/XHR2
                var data = {};

                data.metadata = 'test metadata';
                data.action = "upload_video";
                data.itration = ++count;
                // connection.send(JSON.stringify(data));
                var blobURL = URL.createObjectURL(blob);
                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {
                    base64data = reader.result;
                    // console.log(base64data);
                    // window.open(base64data);
                    // document.write(base64data);
                    data.binary = base64data.replace("data:video/mp4;base64,", "");
                    if (isOpen(connection)) {
                        connection.send(JSON.stringify(data));
                        mediaRecorder.clearOldRecordedFrames();

                    }
                    //mediaRecorder.stop();
                    // mediaRecorder.start(3000);
                }

            };
            mediaRecorder.start(5000);
        }

        function onMediaError(e) {
            console.error('media error', e);
        }
        */
    </script>
    <script>
        /*var player = document.getElementById('player');
        var printData = document.getElementById('printData');
        var count = 0;
        var streamRecorder;
        var webcamstream;
        var connection = new WebSocket('ws://localhost:8765/');
        function isOpen(ws) { return ws.readyState === ws.OPEN }
        connection.onmessage = function (evt) {
            console.log(evt);
            startRecording();
        };
        function startRecording() {
            streamRecorder = webcamstream.record();
            setTimeout(stopRecording, 1000);
        }
        function stopRecording() {
            streamRecorder.getRecordedData(postVideoToServer);
        }
        function postVideoToServer(videoblob) {
            var data = {};
            data.binary = videoblob;
            data.metadata = 'test metadata';
            data.action = "upload_video";
            data.itration=++count;
            connection.send(JSON.stringify(data));
            //jQuery.post("http://www.kongraju.in/uploadvideo.php", data, onUploadSuccess);
            // connection.send(JSON.stringify(data));
        }
        var handleSuccess = function (stream) {
            if (window.URL) {
                player.srcObject = stream;
                webcamstream = stream;
            } else {
                console.log("---" + Math.random());
                player.src = stream;
            }
        };


        alert("ss");
        if (true)
            navigator.mediaDevices.getUserMedia({
                video: {
                    frameRate: 15
                }
            })
                .then(handleSuccess);
    </script>
</body>

</html>